from utc.src.constants.file_system.my_file import MyFile
from utc.src.utils.task_manager import TaskManager
from utc.src.constants.static import FilePaths
from utc.src.utils.options.Options import Options
from typing import Set, Dict


class NetConvertOptions(Options):
    """
    Class representing options for netconvert command (program) and generating
    shell command for modifying / converting networks.
    """
    def __init__(self):
        super().__init__("netconvert")
        self.set_output_switch("-o")
        # Template for network conversion ('.osm' -> '.net.xml')
        self.conversion_template: Dict[str, str] = {
            "geometry.remove": "",  # Remove geometry of buildings
            "ramps.guess": "",  # Guess highway ramps, guess roundabouts, join close junctions
            "roundabouts.guess": "",  # Guess roundabouts,
            "junctions.join": "",  # Join close junctions
            "edges.join": "",  # Join close edges
            "remove-edges.isolated": "",  # Remove unconnected edges
            "keep-edges": "1",  # Keep biggest graph of network
        }

    def convert_network(self, in_network_path: str, in_network_type: str = "osm", out_network_path: str = "") -> bool:
        """
        :param in_network_path: path to input network
        :param in_network_type: type of input network (default 'osm')
        :param out_network_path: output network path
        :return: True on success, false otherwise
        """
        # Check file existence
        if not MyFile.file_exists(in_network_path):
            return False
        # Use netconvert command in shell to modify network
        self.options = " ".join(f"{opt} {opt_val}" for opt, opt_val in self.conversion_template.items())
        self.set_input_switch(f"--{in_network_type}")
        return TaskManager.call_shell_block(self.create_command(in_network_path, out_network_path))[0]

    def extract_subgraph(self, from_network: str, edges: Set[str], to_network: str) -> bool:
        """
        Extracts given edges from given network to create new network only containing
        such edges and junctions connecting them.

        :param from_network: name of network file (UTC/utc/data/maps/sumo)
        :param edges: id's of edges to keep in network
        :param to_network: name of new network file, which will get created (UTC/utc/data/maps/sumo)
        :return: True on success, false otherwise
        """
        # Checks
        from_network = FilePaths.MAP_SUMO.format(from_network)
        to_network = FilePaths.MAP_SUMO.format(to_network)
        if not MyFile.file_exists(from_network):
            return False
        elif MyFile.file_exists(to_network, message=False):
            print(f"Output network name: '{to_network}' already exists!")
            return False
        self.options = f" --keep-edges.explicit \"{', '.join(edges)}\""
        self.set_input_switch("-s")
        return TaskManager.call_shell_block(self.create_command(from_network, to_network))[0]


# For testing purposes
if __name__ == "__main__":
    netconvert_options: NetConvertOptions = NetConvertOptions()
    netconvert_options.extract_subgraph(
        "DCC",
        {'-10575463#3', '-10575468#4', '-10575476#3', '-10575478#5', '-10575480#0', '-10575480#2', '-10575482', '-10577136', '-10861167#1', '-10861167#4', '-110407380#1', '-110445434', '-110445437', '-116689248#1', '-116689248#2', '-125872847#11', '-128521564', '-128946815#1', '-128946815#10', '-128946815#2', '-128946815#4', '-128946815#7', '-129068838', '-13872468#2', '-13872468#4', '-13872815#2', '-13872816#3', '-13872818', '-13878201#1', '-13878201#2', '-13983801#0', '-13983801#1', '-13983801#2', '-14041596#2', '-145571187', '-147463637#0', '-147463637#1', '-153341562', '-153341564#1', '-2110728#3', '-22716630#0', '-22716630#1', '-22716630#3', '-228373543#7', '-2294450#2', '-23009015#3', '-231340188#1', '-23501248#3', '-23501248#4', '-23501248#8', '-25466631#3', '-25466631#6', '-260607183#1', '-26452026#0', '-26452026#1', '-26452026#2', '-26452027#3', '-26452027#9', '-283771398#0', '-285991276', '-30789748', '-31561867#1', '-317312602#1', '-317312602#2', '-317312608', '-319556828#0', '-319556828#6', '-319556829', '-327805506', '-33854575#1', '-360342135#0', '-360342135#1', '-360342135#2', '-360342135#3', '-362967234#0', '-362967234#1', '-362967235#3', '-365945819#0', '-365945819#1', '-36819764', '-370154352#0', '-370154352#1', '-370154355', '-370154357#1', '-372284307#1', '-375758262#1', '-375758262#2', '-375758262#4', '-375772041', '-375778079#2', '-3791031#3', '-3791034#1', '-38023640', '-38554251', '-38574544#1', '-38574544#2', '-38864096#0', '-38864096#1', '-38864097', '-38864098', '-38864099#0', '-38864099#2', '-38864100#1', '-38864103', '-38864104', '-4074527#1', '-4074528#4', '-4074529#2', '-4078064#3', '-409845695#1', '-42879971', '-4315737', '-4475729', '-4475730', '-4475731', '-47638297#3', '-4825310#2', '-4825310#3', '-4825310#5', '-4829640', '-4847328#1', '-48520199', '-4925959#1', '-4926000#3', '-4926004#2', '-4926027#1', '-4926027#3', '-4926030', '-4926110#1', '-4926110#2', '-4926120#3', '-4926189#10', '-4926189#8', '-4934444#0', '-4934444#2', '-4934444#4', '-4934444#5', '-4934444#6', '-4934446#0', '-4934446#2', '-4934446#6', '-4934591', '-4934593', '-4934596#0', '-4934596#1', '-4934596#2', '-4934599#2', '-50502874', '-523892327#0', '-525228766#0', '-525228766#2', '-525228766#5', '-53750892#4', '-563920576', '-57362478#2', '-57362482', '-57362486', '-612719551#3', '-612719558', '-631925361#1', '-63844803#0', '-72097208#0', '-72097208#2', '-72097208#4', '-72097208#9', '-7415907#0', '-7415907#1', '-7415907#3', '-7415911#3', '-7919280#1', '-7919282#1', '-7919284#0', '-7919284#2', '-7919285#0', '-7919285#3', '-7919287#1', '-7919287#5', '-7977023#4', '-7977647#1', '-7977648#1', '-7977648#2', '-7977648#3', '-8111025', '-8166824#1', '-8568389#5', '-8692149#1', '-9186547#14', '10575463#1', '10575468#0', '10575476#0', '10575477#0', '10575477#3', '10575478#0', '10575480#0', '10575480#1', '10575482', '10577136', '10577138#1', '10577341#0', '10861167#0', '10861167#2', '109196045#0', '110407380#0', '110445434', '110445435', '110445437', '110445440', '116689248#1', '116689248#2', '125872847#0', '128521555', '128521564', '128946815#1', '128946815#2', '128946815#4', '128946815#6', '128946815#8', '129068838', '13872468#0', '13872468#3', '13872815#0', '13872816#0', '13872818', '13878201#0', '13878201#2', '13878201#3', '13878225#0', '13890256', '13983801#0', '13983801#1', '13983801#2', '14041596#1', '147463637#0', '147463637#1', '153341562', '153341564#0', '153341565#0', '20834534#0', '20834534#4', '20834536', '2110698#0', '2110728#0', '2110756#3', '22716630#0', '22716630#1', '22716630#2', '228373543#3', '2294310#0', '2294311#0', '2294384#0', '2294449#0', '2294450#0', '2294451', '23009015#0', '230483150#0', '230483150#1', '230483152#0', '231250681#0', '231340188#0', '231340190#0', '231340190#1', '231340191#0', '231340191#1', '231971495#0', '23501248#0', '23501248#4', '23501248#5', '23501249#0', '23719580#0', '25466631#0', '25466631#4', '26452026#0', '26452026#1', '26452026#2', '26452027#0', '26452027#4', '26545993#0', '271848004#1', '27557731#0', '283771393', '283771398#0', '283771398#1', '285991276', '307805528#0', '30789748', '317312602#1', '317312602#2', '317312609', '319556828#1', '33854575#0', '33854576', '344354262', '357012332#0', '357012332#1', '360342135#0', '360342135#1', '360342135#2', '360342135#3', '362967234#0', '362967234#1', '362967235#0', '365945819#0', '365945819#1', '36819764', '370154352#0', '370154352#1', '370154357#0', '372223883#0', '372223883#3', '372223883#7', '372284307#0', '372838323#0', '372838323#1', '375758262#0', '375758262#2', '375758262#3', '375772038#0', '375772038#6', '375772042#0', '375772042#2', '375778079#1', '37721356#0', '378175982#0', '378175982#3', '37883349#0', '37883350#0', '3790875#0', '3790875#2', '3791031#0', '3791033', '3791034#0', '3792427#0', '3792428', '3792490#0', '3792491#0', '37956677#0', '38023640', '38554251', '38574541#0', '38574544#0', '38574544#2', '38864096#0', '38864096#1', '38864097', '38864098', '38864099#0', '38864099#2', '38864100#1', '38864102', '38864103', '38864104', '394171334#1', '398224850#0', '4074527#0', '4074528#0', '4074529#0', '4074531#0', '4074533', '4078064#0', '4078067#0', '419502786#0', '4215695', '4287348#1', '42879970#0', '42879971', '4472590#0', '4475729', '4475730', '4475731', '4476051#0', '4628794#0', '4628794#3', '4628796#1', '4629169#0', '4629169#5', '4629169#8', '4825310#0', '4825310#3', '4825310#4', '4829640', '4847328#0', '48520199', '4925959#0', '4925986#0', '4926000#0', '4926002', '4926004#0', '4926027#0', '4926027#3', '4926030', '4926036#0', '4926036#1', '4926044#0', '4926105#0', '4926110#0', '4926110#2', '4926110#3', '4926120#0', '4926189#0', '4926189#9', '4934444#0', '4934444#2', '4934444#3', '4934444#5', '4934444#6', '4934446#0', '4934446#2', '4934446#3', '4934454', '4934592', '4934596#0', '4934596#1', '4934596#2', '4934599#0', '521969635#0', '521969636', '523892321#0', '523892327#0', '524737392#0', '525228766#0', '525228766#1', '525228766#3', '52879956', '529166766#0', '532096352#0', '532435056#1', '532435057#0', '53750891#0', '53750892#0', '547144822#0', '57362477#0', '57362482', '59604115', '612719551#0', '612719558', '631925372#0', '63844803#0', '63844804', '72097208#1', '72097208#3', '72097208#5', '7415907#0', '7415907#1', '7415907#2', '7415909', '7415911#0', '7849019#2', '7849021#0', '7849022#0', '7919275#1', '7919275#2', '7919275#3', '7919275#4', '7919278#0', '7919280#0', '7919282#0', '7919283#0', '7919284#0', '7919284#2', '7919285#0', '7919285#1', '7919287#0', '7919287#2', '7977023#0', '7977647#0', '7977648#0', '7977648#2', '7977648#3', '8111025', '8166824#0', '83702287#0', '83702287#2', '8568389#0', '8692149#0', '9186547#0', 'gneE16', 'gneE62', 'gneE63'},
        "DCC_side2"
    )





